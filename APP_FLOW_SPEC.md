# アプリケーションフロー仕様書 (MasaCAD Next.js)

**バージョン:** 1.0
**最終更新日:** 2026-01-29

---

## 1. 概要

本ドキュメントは、MasaCADフロントエンドアプリケーション（Next.js版）におけるインソール設計のワークフローを定義します。
設計プロセスは **ステップ1からステップ7** までの順次進行（ウィザード形式）で行われます。

---

## 2. ステップ一覧

| ステップ | 内部ID | 画面名称 | 主な役割 |
|:---:|---|---|---|
| **1** | `PATIENT` | **Patient Selection** | 患者データの選択と基本設定（左右足） |
| **2** | `OUTLINE` | **Outline Editor** | 足型輪郭線の抽出・補正・スケーリング |
| **3** | `LANDMARKS` | **Landmark Settings** | 骨ランドマーク（解剖学的特徴点）の定義 |
| **4** | `SHAPE` | **Basic Shape** | ヒールカップ、壁高さ、ベース厚みの設定 |
| **5** | `ARCH_REGION` | **Arch Region** | アーチ適用範囲（幅・形状）の2D調整 |
| **6** | `ARCH_HEIGHT` | **Arch Height** | アーチ高さ（断面プロファイル）の調整 |
| **7** | `PREVIEW` | **Preview & Export** | 最終3Dモデルの確認、ラティス適用、保存 |

---

## 3. ステップ詳細仕様

### Step 1: 患者選択 (Patient Selection)

**目的:** 設計対象となる患者と、対象の足（左/右）を特定する。

- **主な機能:**
  - 患者リストからの選択（検索・フィルタリング）
  - 足の選択（左足 / 右足）
  - 新規患者の登録（オプション）
- **入力データ:** 患者ID、氏名
- **出力データ:** `patientId`, `footSide`

### Step 2: 輪郭編集 (Outline Editor)

**目的:** 足のスキャン画像や点群データから、インソールの外形となる正確な輪郭線を作成する。

- **主な機能:**
  - 画像の読み込み（背景画像）
  - 輪郭点のプロット・移動・削除（ベジェ曲線またはスプライン）
  - スケーリング調整（画像上の基準線を用いたmm単位への変換）
  - 自動輪郭抽出（OpenCV等による補助、将来機能）
- **UIコンポーネント:** 2D Canvas Editor (`OutlineEditorCanvas`)
- **主要パラメータ:**
  - `outlinePoints`: 輪郭点座標配列 `[{x, y}, ...]`
  - `outlineScale`: ピクセル/mm変換レート

### Step 3: ランドマーク設定 (Landmark Settings)

**目的:** 解剖学的な骨の位置（ランドマーク）を輪郭線上に定義する。これらは後のステップでアーチの位置や壁の形状を自動決定する基準となる。

- **主な機能:**
  - 輪郭線上の特定位置（%）にランドマークを配置
  - **7つの主要ランドマーク:**
    1. **アーチ起始部 (Arch Start)**: 内側縦アーチの始まり
    2. **外側アーチ起始部 (Lat. Arch Start)**: 外側縦アーチの始まり
    3. **距骨下関節 (Subtalar)**: 重心位置の目安
    4. **舟状骨 (Navicular)**: 内側アーチの頂点
    5. **立方骨 (Cuboid)**: 外側アーチの頂点/終点
    6. **内側楔状骨 (Med. Cuneiform)**
    7. **中足骨頭 (Metatarsal)**: アーチの終わり、前足部の始まり
- **UIコンポーネント:** 2D Canvas Editor (`LandmarkEditorCanvas`)
- **主要パラメータ:**
  - `landmarkConfig`: 各ランドマークのX軸位置（0=踵 〜 100=つま先）

### Step 4: 基本形状 (Basic Shape)

**目的:** アーチ以外の基本的なインソール形状（厚み、壁、ヒールカップ）を設定する。

- **主な機能:**
  - **ベース厚み**: 全体の最低厚さ
  - **ヒールカップ**: 踵を包み込む深さ
  - **壁（Wall）の高さ**: 内側・外側の壁の高さ調整
    - 壁の形状はStep 3のランドマーク（舟状骨・立方骨）に基づいて自動的にモーフィングされる。
- **UIコンポーネント:** 3D Viewer + Sliders (`ShapeEditorCanvas`)
- **主要パラメータ:**
  - `baseThickness` (mm)
  - `heelCupHeight` (mm)
  - `medialWallHeight` (mm) / `lateralWallHeight` (mm)
  - `wallHeightOffset` (mm)

### Step 5: アーチ範囲調整 (Arch Region)

**目的:** 3つのアーチ（内側・外側・横）が適用される「範囲」を2D平面上で微調整する。

- **主な機能:**
  - **内側・外側縦アーチ**: 境界曲線をドラッグして「幅」を調整。
  - **横アーチ**: 楕円状の範囲（中足骨付近）をドラッグして調整。
  - **フラット境界**: アーチが立ち上がり始める内側の境界線を調整。
- **操作:** 2D輪郭図上でのベジェ曲線操作
- **UIコンポーネント:** 2D Canvas Editor (`ArchRegionEditorCanvas`)
- **主要パラメータ:**
  - `archCurves`: アーチ境界線の制御点データ
  - `widthConfig`: 幅方向の基準線（Ray1, Ray5など）

### Step 6: アーチ高さ調整 (Arch Height)

**目的:** Step 5で定義した範囲に対し、立体的な「高さ」を設定する。

- **主な機能:**
  - **断面ビュー**: X軸スライダーを動かし、任意の位置での断面形状（プロファイル）を確認。
  - **高さ調整**:
    - 内側縦アーチ高さ (Medial Height)
    - 外側縦アーチ高さ (Lateral Height)
    - 横アーチ高さ (Transverse Height)
  - 左右の足で個別に設定可能。
- **操作:** スライダー調整 + リアルタイム断面プレビュー
- **UIコンポーネント:** Cross Section Viewer (`ArchAdjustmentCanvas`)
- **主要パラメータ:**
  - `archSettings`: 各アーチの高さ(mm)とピーク位置情報

### Step 7: プレビュー・出力 (Preview & Export)

**目的:** 最終的な3Dモデルを確認し、ラティス構造を適用してエクスポートする。

- **主な機能:**
  - **3Dプレビュー**: 完成形状の確認（回転・拡大・断面表示）。
  - **ラティス設定**:
    - ラティス適用のON/OFF
    - セルサイズ (Cell Size)
    - ストラット径 (Strut Radius)
  - **ヒートマップ**: 厚みや高さの可視化。
  - **エクスポート**: STL / GLB / G-code 形式でのダウンロード。
- **UIコンポーネント:** Full 3D Viewer (`PreviewStep`)
- **出力:** 生成された3Dメッシュファイル

---

## 4. データフロー

1. **Step 1〜3**: 2Dデータの構築（輪郭 + ランドマーク）
2. **Step 4**: 3Dベース形状のパラメータ設定
3. **Step 5**: アーチ適用領域（マスク）の生成
4. **Step 6**: アーチ高さパラメータの確定
5. **Backend**: すべてのパラメータを受け取り、メッシュ生成を実行
6. **Step 7**: 生成されたメッシュの表示とラティス処理

---
