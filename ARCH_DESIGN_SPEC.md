# MasaCAD v4.3 アーチ設計仕様書

**簡易版アーチ設定による パラメトリックインソール生成**

---

## 1. 概要

MasaCAD v4.3では、アーチ設計を**簡易版**と**詳細版**に分けて管理します。
現在は簡易版を実装しており、詳細版は将来の拡張として計画されています。

---

## 2. アーチの種類

### 2.1 3つの主要アーチ

| アーチ名 | 英語名 | 解剖学的位置 | 機能 |
|---------|--------|-------------|------|
| **内側縦アーチ** | Medial Longitudinal Arch | 踵骨〜舟状骨〜第1中足骨 | 衝撃吸収・推進力 |
| **外側縦アーチ** | Lateral Longitudinal Arch | 踵骨〜立方骨〜第5中足骨 | 安定性・バランス |
| **横アーチ** | Transverse Arch | 第2-4中足骨頭部 | 前足部の荷重分散 |

### 2.2 配置イメージ

```
     つま先 (100%)
         │
    ┌────┴────┐
    │  横アーチ │  ← 60-75% 位置（第2-4中足骨）
    │  🟡🟡🟡  │
    │         │
    │ ┌─────┐ │
    │ │内側 │ │  ← 内側縦アーチ（20-55%）
    │ │ 🔵  │ │
    │ └─────┘ │
    │         │
    │ ┌─────┐ │
    │ │外側 │ │  ← 外側縦アーチ（20-40%）
    │ │ 🟢  │ │
    │ └─────┘ │
    │         │
    └────┬────┘
         │
      踵 (0%)
```

---

## 3. 簡易版アーチ設定（v4.3で実装）

### 3.1 パラメータ一覧

#### 内側縦アーチ（Medial Arch）

| パラメータ | 単位 | デフォルト | 範囲 | 説明 |
|-----------|------|-----------|------|------|
| `medial_start` | % | 20.0 | 0-50 | かかとからアーチが始まる位置 |
| `medial_end` | % | 55.0 | 30-80 | アーチが終了する位置 |
| `medial_height` | mm | 1.0 | 0-15 | アーチの最大高さ |

#### 外側縦アーチ（Lateral Arch）

| パラメータ | 単位 | デフォルト | 範囲 | 説明 |
|-----------|------|-----------|------|------|
| `lateral_start` | % | 20.0 | 0-50 | かかとからアーチが始まる位置 |
| `lateral_end` | % | 40.0 | 25-60 | アーチが終了する位置 |
| `lateral_height` | mm | 1.0 | 0-10 | アーチの最大高さ |

#### 横アーチ（Transverse Arch）

| パラメータ | 単位 | デフォルト | 範囲 | 説明 |
|-----------|------|-----------|------|------|
| `transverse_start` | % | 60.0 | 40-80 | かかとからアーチが始まる位置 |
| `transverse_end` | % | 75.0 | 60-95 | アーチが終了する位置 |
| `transverse_height` | mm | 1.0 | 0-10 | アーチの最大高さ |

### 3.2 アーチ全体倍率

| パラメータ | 単位 | デフォルト | 範囲 | 説明 |
|-----------|------|-----------|------|------|
| `arch_scale` | 倍率 | 1.0 | 0.5-2.0 | 全アーチ高さに対する倍率 |

### 3.3 高さプロファイル

各アーチの高さは**スムーズステップ関数**（S字カーブ）で補間されます：

```
高さ
  │      ___/\___
  │     /        \
  │    /          \
  │___/            \___
  └─────────────────────→ X位置
    start  peak  end
```

- **peak位置**: (start + end) / 2 で自動計算
- **S字カーブ**: `t² × (3 - 2t)` で滑らかな遷移

### 3.4 Y方向の適用範囲

| アーチ | Y方向適用範囲 | 説明 |
|--------|-------------|------|
| 内側縦アーチ | Y=0.6〜1.0 | 内側（土踏まず側）60%以上 |
| 外側縦アーチ | Y=0.0〜0.4 | 外側（小指側）40%以下 |
| 横アーチ | Y=0.3〜0.7 | 中央部分（内外アーチの間） |

---

## 4. 詳細版アーチ設定（将来実装予定）

### 4.1 骨ごとの個別設定

| 骨名 | 英語名 | 設定項目 |
|-----|--------|---------|
| 踵骨 | Calcaneus | ヒールカップ深さ |
| 距骨 | Talus | 内側隆起 |
| 舟状骨 | Navicular | 内側アーチピーク |
| 立方骨 | Cuboid | 外側アーチピーク |
| 楔状骨（3つ） | Cuneiforms | 中足部支持 |
| 中足骨（5本） | Metatarsals | 個別高さ設定 |

### 4.2 予定機能

- [ ] 骨ごとの高さスライダー
- [ ] 足のサイズに応じた自動位置調整
- [ ] 3D可視化での骨位置表示
- [ ] プリセット保存/読み込み

---

## 5. 技術仕様

### 5.1 API使用方法

```python
from core.geometry_v4 import generate_insole_from_outline

# アーチ設定
arch_settings = {
    'medial_start': 20.0,
    'medial_end': 55.0,
    'medial_height': 5.0,
    'lateral_start': 20.0,
    'lateral_end': 40.0,
    'lateral_height': 2.5,
    'transverse_start': 60.0,
    'transverse_end': 75.0,
    'transverse_height': 2.0,
}

mesh = generate_insole_from_outline(
    outline_csv_path='patients/0001/outline.csv',
    arch_settings=arch_settings,
    arch_scale=1.0,
    base_thickness=3.0,
)
```

### 5.2 ファイル構成

```
core/
└── geometry_v4.py    # v4.3 アーチ簡易設定対応
    ├── DEFAULT_ARCH_SETTINGS  # デフォルト値
    ├── generate_arch_profile()  # 動的プロファイル生成
    ├── _calculate_arch_height()  # S字カーブ計算
    └── create_profile_interpolators()  # 補間関数生成

ui/
└── app_v4.py         # Streamlit UI
    └── アーチ設定（簡易版）セクション
```

---

## 6. 変更履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| v4.3 | 2025-01-04 | 簡易版アーチ設定（内側/外側/横アーチ）実装 |
| v4.2 | 2024-12-28 | ハイブリッド方式メッシュ生成 |
| v4.0 | 2024-12-27 | 輪郭ベース生成エンジン |

---

**作成日**: 2025-01-04  
**バージョン**: v4.3-arch-simple
