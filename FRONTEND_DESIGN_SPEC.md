# フロントエンド初期設計書 (MasaCAD v5 UI)

**バージョン:** 1.0
**作成日:** 2026-01-20
**担当:** Gemini

---

## 1. 概要

### 1.1. プロジェクト目的
本プロジェクトは、Pythonで構築された既存のインソール生成ロジックをバックエンドAPIとして活用し、全く新しいプロフェッショナルなフロントエンドを構築することを目的とする。

### 1.2. ターゲットユーザー
インソールの設計・調整を行う義肢装具士やセラピスト。

### 1.3. 設計思想
- **プロフェッショナル & 信頼感:** 医療現場での使用に耐えうる、正確で分かりやすい情報提示を行う。
- **効率的な操作性:** CADライクな直感的な操作で、設計プロセスを高速化する。
- **高い拡張性:** 将来的な機能追加（AI連携、他のラティス構造など）に柔軟に対応できるアーキテクチャとする。

### 1.4. 技術スタック
- **言語:** TypeScript
- **フレームワーク:** Next.js (App Router)
- **スタイリング:** Tailwind CSS
- **UIコンポーネント:** shadcn/ui (Radix UI)
- **3D描画:** React Three Fiber (three.js), drei
- **状態管理:** Zustand (クライアント状態), React Query (サーバー状態)
- **コード品質:** ESLint, Prettier

---

## 2. デザインシステム (Bionic Sole)

**デザインの唯一の正 (Single Source of Truth)**
本セクションは、アプリケーション全体のデザイン基盤を定義する。
ロゴ（濃紺〜ターコイズ）の世界観に基づき、**「先進的な生体工学ラボ」**をテーマとする。

### 2.1. カラーパレット (Dark First)
原則として**ダークモード**を標準とし、深いネイビーを基調にターコイズのアクセントを用いる。

| 用途 | 変数名 | HSL値 (参考) | Hex (参考) | 説明 |
|---|---|---|---|---|
| **Background (Main)** | `--background` | `218 33% 15%` | `#1A2B3D` | 画面全体の背景。深いネイビー。 |
| **Foreground (Main)** | `--foreground` | `0 0% 100%` | `#FFFFFF` | 主要テキスト。純白。 |
| **Card (Surface)** | `--card` | `216 38% 19%` | `#1E2D42` | カード、サイドバー、ヘッダーの背景。背景よりわずかに明るい。 |
| **Card Foreground** | `--card-foreground` | `210 40% 98%` | `#F8FAFC` | カード上のテキスト。 |
| **Popover** | `--popover` | `216 38% 19%` | `#1E2D42` | ドロップダウンメニュー等。Cardと同一。 |
| **Popover Foreground** | `--popover-foreground` | `210 40% 98%` | `#F8FAFC` | |
| **Primary (Accent)** | `--primary` | `173 80% 40%` | `#14B8A6` | ロゴの中核色（ターコイズ）。ボタン、リンク、アクティブ状態。 |
| **Primary Foreground** | `--primary-foreground` | `222 47% 11%` | `#0F172A` | Primary上のテキスト。濃紺。 |
| **Secondary** | `--secondary` | `217 33% 25%` | `#2D3A4F` | 補助的なボタン背景など。 |
| **Secondary Foreground**| `--secondary-foreground` | `210 40% 98%` | `#F8FAFC` | |
| **Muted** | `--muted` | `217 33% 25%` | `#2D3A4F` | 無効状態、スライダーのトラック背景。 |
| **Muted Foreground** | `--muted-foreground` | `215 20% 65%` | `#94A3B8` | 補足テキスト、ラベル。 |
| **Accent** | `--accent` | `173 80% 40%` (Alpha 10%) | - | ホバー時の微かなハイライト。Primaryの透過色などを利用。 |
| **Accent Foreground** | `--accent-foreground` | `173 80% 40%` | `#14B8A6` | アクセント時のテキスト色。 |
| **Destructive** | `--destructive` | `0 62% 30%` | `#7F1D1D` | 危険な操作。 |
| **Destructive Fg** | `--destructive-foreground` | `210 40% 98%` | `#F8FAFC` | |
| **Border** | `--border` | `217 33% 25%` | `#334155` | 区切り線。背景に馴染む色。 |
| **Input** | `--input` | `217 33% 25%` | `#334155` | 入力フォームの枠線。 |
| **Ring** | `--ring` | `173 80% 40%` | `#14B8A6` | フォーカスリング。Primaryと同一。 |

**特記事項: グラデーション (Primary Gradient)**
ロゴの流動性を表現するため、以下のCSSグラデーションを「ここぞという場所」（CTAボタン、プログレスバー、ヘッダーのアクセントライン）にのみ使用する。
`linear-gradient(90deg, #0E7490 0%, #14B8A6 50%, #2DD4BF 100%)`
※ テキスト全体や背景全体には使用しないこと。

### 2.2. タイポグラフィ
ロゴの形状（太く、角が丸いモダンサンセリフ）に合わせ、可読性と先進性を両立する。

- **Font Family**: `Inter` (または `Plus Jakarta Sans`)
- **Weights**:
  - **Bold (700)**: ページタイトル、ステップ名（レベル1情報）
  - **Medium (500)**: セクション見出し、ボタンテキスト（レベル2情報）
  - **Regular (400)**: 本文、入力値（レベル3情報）
- **Scale**: Tailwind標準を使用。
  - `text-2xl/3xl`: ページタイトル
  - `text-lg/xl`: セクション見出し
  - `text-sm/base`: 本文、コントロール

### 2.3. 形状・スペーシング・エレベーション
- **角丸 (Border Radius)**: `--radius: 0.5rem` (8px)。ロゴの「わずかに丸い角」を継承。
  - カード、ボタン、入力フィールド: `rounded-md` (0.5rem)
  - 大きなコンテナ: `rounded-lg` (0.75rem)
- **スペーシング**: 8px (0.5rem) を基本単位とする。
  - コンポーネント内余白: `p-4` (16px) または `p-6` (24px)
  - 要素間隔: `gap-2` (8px) ～ `gap-4` (16px)
- **影 (Shadow)**: 100%フラットなデザインを追求するため、`shadow`系のクラスは一切使用しない。背景色の明度差とボーダー（1px）で階層を表現する。
- カード: 影なし、`border-white/5`
- 浮遊要素 (ドロップダウン等): 影なし、`border-white/10`、`backdrop-blur`
- **光彩 (Glow)**: `drop-shadow` や `glow` 系のエフェクトも禁止。
- **アニメーション**: `animate-pulse` 等の点滅エフェクトは、ラボラトリーとしての静的な精密さを優先するため原則禁止。
### 2.4. コンポーネントルール
一貫性を保つためのルール。

1. **ヘッダー**: 背景は `--card`。下部に `--border`。アプリアイコン/タイトルは白。
2. **サイドバー**: 背景は `--card`。パラメータグループ見出しは `muted-foreground`。
3. **ボタン**:
   - **Primary**: 背景 `primary` (または `primary-gradient`)、文字 `primary-foreground`。
   - **Secondary/Outline**: ボーダー `input`、ホバー時に `accent`。
   - **Ghost**: 背景なし、ホバー時に `accent`。
4. **入力 (Input/Slider)**:
   - スライダーのトラックは `muted`、つまみは `primary`。
   - テキスト入力のフォーカスリングは `ring` (`primary`色)。
5. **3Dキャンバス**: 背景は `--background` (濃紺) で統一し、UIパネルが浮いているように見せる。

### 2.5. 情報階層
- **Level 1 (最重要)**: 画面タイトル、現在ステップ。白 (`foreground`) + Bold。
- **Level 2 (区分)**: パラメータグループ名。白 (`foreground`) + Medium。
- **Level 3 (詳細)**: ラベル、説明文。グレー (`muted-foreground`) + Regular。
- **Accent**: 現在の値、アクティブな選択肢。ターコイズ (`primary`)。

---

## 3. アプリケーションレイアウト

画面は大きく3つの領域で構成される。

```
+--------------------------------------------------------------------------+
| Header (患者名、保存ボタン、Undo/Redo、ライト/ダーク切替)                  |
+--------------------------------------------------------------------------+
|                                |                                         |
|                                |                                         |
| Sidebar (左)                   | Main Content                            |
| (パラメータ調整スライダー、     | (3Dビューア)                            |
|  断面表示設定、ヒートマップ設定) |                                         |
|                                |                                         |
|                                |                                         |
|                                |                                         |
+--------------------------------+-----------------------------------------+
```

---

## 4. 主要機能とコンポーネント

### 4.1. 3Dビューア (`<Canvas3D />`)
- **役割:** インソールモデルの表示と操作。
- **機能:**
  - **カメラ操作:** CADライクな操作（右ボタンドラッグで回転、中ボタンドラッグでパン、ホイールでズーム）。`@react-three/drei`の`<CameraControls>`を利用。
  - **モデル表示:** GLB/STL形式のメッシュを表示。
  - **断面表示:** XY, YZ, XZ平面での断面表示。平面をドラッグして断面位置を動かせる。
  - **ヒートマップ表示:** 頂点データに基づいて、メッシュ表面を色分け表示（厚み、アーチの高さなど）。
- **主要コンポーネント:**
  - `<InsoleModel />`: インソールのメッシュとマテリアルを管理。
  - `<ClippingPlaneControls />`: 断面表示用の平面を制御。
  - `<HeatmapLegend />`: ヒートマップの凡例を表示。

### 4.2. パラメータ調整サイドバー (`<Sidebar />`)
- **役割:** インソール形状を制御するパラメータの調整。
- **主要コンポーネント (`@/components/ui`):**
  - `<Slider />`: アーチの高さなど、連続値を調整。
  - `<Input />`: 正確な数値を入力。
  - `<Select />`: プリセットなどを選択。
  - `<Accordion />`: パラメータをグループ化して表示。
  - `<Button />`: 更新ボタンなど。

### 4.3. 詳細UI仕様: 基本形状編集
単純なパラメータ入力に加え、2D断面ビューを用いた直感的な形状編集機能を提供する。

#### A. 編集モードとビュー
画面上に「内側ビュー (Medial View)」と「外側ビュー (Lateral View)」の2つの2Dプロファイルエディタを表示する。

**1. 内側ビュー (Medial Side Profile)**
- **表示内容**: インソールを内側から見た断面形状（YZ平面に相当するが、X軸に沿った高さプロファイル）。
- **操作可能な要素**:
  - **ヒールカップ高さ (Heel Cup Height)**: 踵後端の高さ [mm]。
  - **内側アーチ/内壁の頂点 (Medial Wall Peak)**:
    - **高さ**: 上下ドラッグで変更。
    - **タイミング (X位置)**: 左右ドラッグで頂点の位置（舟状骨付近）を調整。
  - **ベース厚み (Base Thickness)**: 底面の厚さ。

**2. 外側ビュー (Lateral Side Profile)**
- **表示内容**: インソールを外側から見た断面形状。
- **操作可能な要素**:
  - **ヒールカップ高さ**: 内側と連動または独立（要検討、初期は連動）。
  - **外壁の頂点 (Lateral Wall Peak)**:
    - **高さ**: 上下ドラッグで変更。
    - **タイミング (X位置)**: 左右ドラッグで頂点の位置を調整。
  - **外壁の終端**: 壁が0mmになる位置。

#### B. インタラクション要件
- **ドラッグ操作**: プロファイル曲線上の制御点（コントロールポイント）をマウスでドラッグ可能にする。
- **数値入力**: ドラッグ操作と連動する数値入力フィールドを併設し、精密なmm単位の指定も可能にする。
- **リアルタイムフィードバック**:
  - ドラッグ中に現在の高さ（mm）と移動量（Δmm）をツールチップ表示。
  - 変更に伴い、3Dプレビュー（簡易表示モードがあれば）またはプロファイル曲線を即座に更新。

#### C. パラメータ仕様（Backend連携用）
従来の「倍率」ではなく、具体的な「ミリメートル (mm)」で管理する。

| パラメータ名 | 型 | 単位 | 説明 |
|---|---|---|---|
| `base_thickness` | float | mm | 全体のベース厚み |
| `heel_cup_height` | float | mm | ヒールカップ（踵後端）の深さ/高さ |
| `medial_wall_height` | float | mm | 内側アーチ/壁の最大高さ |
| `medial_wall_peak_x` | float | % | 内側アーチ頂点のX位置（0-100%） |
| `lateral_wall_height` | float | mm | 外壁の最大高さ |
| `lateral_wall_peak_x` | float | % | 外壁頂点のX位置 |

---

## 5. ディレクトリ構造 (`src` ディレクトリ内)

```
src
├── app/                  # Next.jsのルーティング (例: page.tsx, layout.tsx)
├── components/
│   ├── ui/               # shadcn/uiによって生成されるUIコンポーネント
│   ├── layout/           # Header, Sidebarなどのレイアウトコンポーネント
│   └── canvas/           # 3Dビューア関連のReact Three Fiberコンポーネント
├── lib/
│   ├── utils.ts          # 共通のユーティリティ関数
│   └── hooks/            # カスタムReactフック
├── styles/
│   └── globals.css       # グローバルなCSS設定
└── types/
    └── index.ts          # プロジェクト全体のTypeScript型定義
```

---
## 6. API連携仕様 (ドラフト)

フロントエンドは、バックエンドのFastAPIサーバーと以下のエンドポイントで通信する（想定）。

- **`POST /api/v1/generate-insole`**
  - **リクエスト:** インソールパラメータを含むJSON
  - **レスポンス:** 生成されたインソールの3Dモデルデータ（GLB形式）

- **`GET /api/v1/patients`**
  - **レスポンス:** 患者リスト（ID、氏名など）のJSON配列

- **`GET /api/v1/patients/{patient_id}`**
  - **レスポンス:** 特定患者の詳細データと、関連するインソール設定のJSON

---
*この設計書は初期バージョンであり、プロジェクトの進行に応じて更新されるものとします。*

