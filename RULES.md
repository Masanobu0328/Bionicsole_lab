# RULES.md - AI共通ルール

このファイルはClaude Code・Codex共通の運用ルールを定義する。
各AIはこのファイルを最優先で参照すること。

---

## 1. 言語設定

- **応答**: 常に日本語
- **コード内コメント・変数名**: 英語
- **UI文字列**: 日本語

---

## 2. コア保護ルール（最重要）

以下は **コア領域** であり、明示的な許可がある場合のみ変更可：

```
core/geometry_v4_frontend.py  ← 本番用メッシュ生成（修正対象）
core/lattice.py
core/xcell_3d.py
core/landmarks.py
core/validate.py
```

これらは医療用途・AI学習前提の中核ロジックである。
**明示的な許可がない場合は変更禁止。許可があった場合は変更を実施する。**

### geometry_v4 ファイルの使い分け（重要）

| ファイル | 用途 | 編集可否 |
|----------|------|----------|
| `geometry_v4_frontend.py` | **本番用** - Next.jsが使用 | **こちらを編集** |
| `geometry_v4.py` | 開発用 - Streamlit等で使用 | **編集しない** |

**メッシュ生成・ヒールカップ・トランジション等の修正は必ず `geometry_v4_frontend.py` を編集すること。**
`geometry_v4.py` を編集しても本番環境には反映されない。
ユーザーが明示的に「開発用を編集して」と指示した場合のみ `geometry_v4.py` を編集する。

### フロントエンド開発時のバックエンド保護

**Next.jsフロントエンド（`frontend/`）を変更する際のルール：**

1. **コアロジック（`core/`）は原則変更しない（明示的許可がある場合のみ可、許可があった場合は変更する）**
   - フロントエンドのUI変更は、コアエンジンの動作に影響を与えない
   - `core/geometry_v4.py` などの関数シグネチャや内部ロジックは、許可がない場合は変更禁止。許可があった場合は変更する

2. **Streamlit UI（`ui/app.py`）は変更しない**
   - フロントエンド開発時に`ui/app.py`を誤って変更しないこと
   - `ui/app.py`は開発用UIとして独立して動作する
   - フロントエンドの変更依頼時は、`frontend/`ディレクトリのみを対象とする

3. **APIエンドポイント（`backend/api/endpoints.py`）の変更は最小限に**
   - フロントエンドのUI変更に必要な場合のみ、APIエンドポイントを変更可能
   - ただし、既存のエンドポイントのシグネチャ変更は禁止
   - 新規エンドポイント追加は許可（ユーザー承認後）

4. **API呼び出し（`frontend/src/lib/api.ts`）は自由に変更可能**
   - フロントエンド側のAPI呼び出し方法は変更可能
   - 型定義（TypeScript）の追加・変更も許可

5. **バックエンドの大まかな仕組みは変更しない**
   - FastAPIの構造（`backend/main.py`）は変更しない
   - タスク管理システム（`backend/api/endpoints.py` の `TaskManager`）は変更しない
   - コアエンジンの呼び出し方法（`generate_insole_from_outline()` など）は変更しない

**変更可能な範囲：**
- ✅ `frontend/` ディレクトリ内の全ファイル
- ✅ `frontend/src/lib/api.ts` のAPI呼び出しロジック
- ✅ UIコンポーネント、スタイル、状態管理

**変更禁止の範囲（許可がない場合）：**
- ❌ `core/` ディレクトリ内の全ファイル（**絶対変更禁止**。デザイン修正タスクでここを触ることはあり得ない）
- ❌ `ui/app.py`（Streamlit開発用UI）
- ❌ `backend/api/endpoints.py` の既存エンドポイントシグネチャ
- ❌ `backend/main.py` の基本構造
- ❌ コアエンジン関数の呼び出し方法（パラメータ名・順序など）

**フロントエンド開発時の注意：**
- フロントエンドの変更依頼を受けたら、`frontend/`ディレクトリのみを対象とする
- `ui/app.py`や`core/`ディレクトリは、明示的許可がない場合は変更しない
- `core/`ディレクトリの変更について明示的許可があった場合は、変更を実施する
- 誤って変更してしまった場合は、すぐに報告すること

---

## 3. 破壊的変更の禁止

以下を独断で行わないこと：
- ファイル削除
- API仕様変更
- 型・データ構造の変更
- 既存の公開関数のシグネチャ変更

---

## 4. 承認フロー

### 実装前の確認（必須）

コードを変更する前に、以下を説明すること：
- **どのファイル**を変更するか
- **なぜ**その変更が必要か
- **どのように**変更するか

### 承認モード

| モード | 許可される操作 |
|--------|---------------|
| Read-only | 計画・方針の提示のみ |
| Full Access | 承認済み計画に基づく実装 |

---

## 5. コーディング規約

### 命名規則

- 既存コードのスタイルに従う
- `geometry_v4.py` のパターンを参考にする

### 型安全

- 型ヒント（typing）を活用
- `Any` の乱用を避ける

### エラーハンドリング

- ファイルI/Oや外部処理には適切な `try-except` を実装

### ファイル操作

- パスは `pathlib.Path` を使用
- 出力先: `exports/`
- 患者データ: `patients/{id}/outline.csv`

---

## 6. 禁止事項

### 絵文字禁止（重要）

Windowsのcp932エンコーディングは絵文字を処理できない。
以下では絶対に絵文字を使用しないこと：
- `print()` 文
- ログメッセージ
- core/ モジュール内の文字列

```python
# NG
print(f"Status: {'✅' if ok else '❌'}")

# OK
print(f"Status: {'[OK]' if ok else '[NG]'}")
```

### その他

- 過剰な抽象化（1回しか使わない処理のユーティリティ化）
- 依頼範囲外の「改善」
- 未確認のまま大規模変更

---

## 7. メッシュ操作ルール

- メッシュ操作後は watertight を検証
- ブーリアン演算は manifold3d エンジン推奨

---

## 8. 参照ドキュメント

| ファイル | 内容 |
|----------|------|
| README.md | プロジェクト基盤 |
| CLAUDE.md | Claude Code専用指示 |
| AGENTS.md | Codex専用指示 |
