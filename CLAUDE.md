# CLAUDE.md - Claude Code専用指示

Claude Codeは設計・相談・大規模実装・リファクタリングを担当する。
共通ルールは **RULES.md** を参照すること。

---

## 役割

- ユーザーとの設計相談
- アーキテクチャの理解と説明
- 大規模実装・リファクタリング
- 実装方針の策定と計画立案

---

## 相談プロセス

### 1. 要件の確認

ユーザーの依頼を受けたら、まず以下を確認：
- **何を**実現したいか
- **なぜ**その機能が必要か
- **制約**はあるか（パフォーマンス、互換性など）

### 2. 影響範囲の分析

変更前に以下を説明：
- 影響を受けるファイル一覧
- 既存機能への影響
- リスクと対策

### 3. 計画の提示

実装前にRead-onlyモードで計画を提示：
- 変更内容の箇条書き
- 実装順序
- 確認ポイント

---

## 設計思想

### プロジェクト概要

MasaCADは医療用インソールを自動生成するAI対応CADシステム。
足の輪郭データ（CSV）から3Dプリント可能なカスタムインソールを生成する。

- **バージョン**: v4.3
- **言語**: Python 3.10+

### アーキテクチャ

```
CSV（足輪郭）
    → geometry_v4.py（メッシュ生成）
    → landmarks.py（アーチ位置決め）
    → xcell_3d.py（ラティス適用・オプション）
    → validate.py（メッシュ検証）
    → STL/GLB出力
```

### コアエンジン (`core/`)

| ファイル | 役割 | 主要関数 |
|----------|------|----------|
| `geometry_v4_frontend.py` | **本番用メッシュ生成エンジン** | `generate_insole_from_outline()` |
| `geometry_v4.py` | 開発用（編集しない） | - |
| `landmarks.py` | 解剖学的ランドマーク | `DEFAULT_BONE_LANDMARKS` |
| `xcell_3d.py` | 3D X-Cellラティス | `apply_3d_xcell_lattice()` |
| `lattice.py` | ラティスユーティリティ | `create_xcell_unit_cell()` |
| `validate.py` | メッシュ検証・修復 | `validate_mesh()`, `repair_mesh()` |

### 重要: geometry_v4 ファイルの使い分け

**絶対に間違えないこと！**

| ファイル | 用途 | 編集可否 |
|----------|------|----------|
| `geometry_v4_frontend.py` | **本番用** - Next.jsフロントエンドが使用 | **こちらを編集する** |
| `geometry_v4.py` | 開発用 - Streamlit等で使用 | **編集しない**（明示的指示がある場合のみ） |

メッシュ生成、ヒールカップ、トランジション等の修正は **必ず `geometry_v4_frontend.py` を編集すること**。
`geometry_v4.py` を編集しても本番環境には反映されない。

### UI（本番環境）

**重要: 本番環境は `frontend/` ディレクトリのReact/Next.jsアプリを使用する。**

| ディレクトリ | 役割 |
|-------------|------|
| `frontend/` | 本番用UI（React/Next.js） |
| `core/geometry_v4_frontend.py` | **本番用バックエンド（こちらを編集）** |

### UI（開発用 - 使用しない）

| ファイル | 役割 | 備考 |
|----------|------|------|
| `ui/app.py` | Streamlit開発用 | **本番では使用しない** |
| `core/geometry_v4.py` | 開発用メッシュ生成 | **本番では使用しない** |
| `patient_manager.py` | 患者データ管理 | 開発用 |

**注意**: Streamlit (`ui/app.py`) と `geometry_v4.py` は開発・デバッグ用であり、本番環境では使用しない。
メッシュ生成の修正は `geometry_v4_frontend.py` を対象とすること。

---

## 座標系

- **X軸**: 0%=かかと、100%=つま先（足の長さ方向）
- **Y軸**: 0=外側（小指側）、1=内側（土踏まず側）
- **Z軸**: 0=底面（平坦）、上方向=上面
- **単位**: 全てミリメートル（mm）

---

## 主要コンセプト

### 3種類のアーチ（v4.3）

| アーチ | 英語名 | Y範囲 | デフォルト位置 |
|--------|--------|-------|---------------|
| 内側縦アーチ | Medial Longitudinal | 0.6-1.0 | 20-55% |
| 外側縦アーチ | Lateral Longitudinal | 0.0-0.4 | 20-40% |
| 横アーチ | Transverse | 0.3-0.7 | 60-75% |

### アーチパラメータ例

```python
arch_settings = {
    'medial_start': 20.0,    # かかとからの開始位置（%）
    'medial_end': 55.0,      # 終了位置（%）
    'medial_height': 1.0,    # 高さ（mm）
    'lateral_start': 20.0,
    'lateral_end': 40.0,
    'lateral_height': 1.0,
    'transverse_start': 60.0,
    'transverse_end': 75.0,
    'transverse_height': 1.0,
}
```

---

## リファクタリング方針

### 実施前の確認事項

1. **目的の明確化**: なぜリファクタが必要か
2. **影響範囲**: どのファイル・関数に影響するか
3. **テスト計画**: どう動作確認するか

### 原則

- 既存の動作を壊さない（振る舞いの保持）
- 小さなステップで進める
- 各ステップ後に動作確認
- コア領域（RULES.md参照）は慎重に扱う

---

## 判断基準

### 実装すべきか迷ったら

| 状況 | 判断 |
|------|------|
| 依頼された範囲内 | 実装する |
| 明らかなバグ修正 | 報告して確認を取る |
| 「ついでに」の改善 | 実装しない（提案のみ） |
| コア領域の変更 | 必ず事前承認を得る |

### 設計判断に迷ったら

- 既存コード（特に`geometry_v4.py`）のパターンに従う
- 迷ったらユーザーに質問する
- 複数案がある場合は選択肢を提示する

---

## 開発コマンド

```bash
# 依存関係インストール
pip install -r requirements.txt

# 本番フロントエンド起動
cd frontend && npm run dev

# ブーリアン演算安定化（オプション）
pip install manifold3d
```

**注意**: `streamlit run ui/app.py` は開発用であり、本番環境では使用しない。

---

## よくある問題

| 問題 | 原因 | 対処 |
|------|------|------|
| UnicodeEncodeError: cp932 | print文に絵文字 | ASCII文字に置換 |
| ブーリアン演算失敗 | blenderエンジン制限 | manifold3dをインストール |
| メッシュがwatertightでない | 非多様体エッジ | `repair_mesh()`を使用 |

---

## 参照ドキュメント

| ファイル | 内容 |
|----------|------|
| `RULES.md` | **AI共通ルール（必読）** |
| `README.md` | プロジェクト基盤 |
| `AGENTS.md` | Codex専用指示 |
| `TODO.md` | タスク管理・進捗 |
| `ARCH_DESIGN_SPEC.md` | v4.3アーチ設計仕様 |
| `README_XCELL.md` | X-Cellラティス仕様 |
| `GLOSSARY.md` | 日英用語集 |
